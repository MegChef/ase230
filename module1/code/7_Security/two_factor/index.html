<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-Factor Authentication Demo - Enhanced</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            line-height: 1.6;
        }
        .step { 
            background: #f8f9fa; 
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px; 
            margin: 15px 0; 
        }
        .step.active {
            border-color: #007bff;
            background: #e7f3ff;
        }
        .step.completed {
            border-color: #28a745;
            background: #d4edda;
        }
        .step.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }
        input, button { 
            padding: 10px; 
            margin: 5px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        button { 
            background: #007bff; 
            color: white; 
            cursor: pointer; 
        }
        button:hover { background: #0056b3; }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .reset-btn {
            background: #dc3545;
        }
        .reset-btn:hover {
            background: #c82333;
        }
        .status-btn {
            background: #17a2b8;
        }
        .status-btn:hover {
            background: #138496;
        }
        .response { 
            background: #e9ecef; 
            padding: 15px; 
            border-radius: 4px; 
            margin: 10px 0; 
            white-space: pre-wrap; 
            font-family: monospace;
            font-size: 14px;
        }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .warning { border-left: 4px solid #ffc107; }
        .info { border-left: 4px solid #17a2b8; }
        .qr-code { 
            text-align: center; 
            margin: 20px 0; 
        }
        .qr-code img { 
            border: 1px solid #ddd; 
            padding: 10px; 
            background: white;
        }
        .code-input {
            font-size: 24px;
            text-align: center;
            letter-spacing: 8px;
            width: 200px;
        }
        .manual-key {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .status-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <h1>üîê Two-Factor Authentication Demo - Enhanced</h1>
    
    <div class="info-box">
        <strong>üì± Need an Authenticator App?</strong><br>
        Download: Google Authenticator, Microsoft Authenticator, or Authy<br>
        <strong>üîÑ New Features:</strong> Check status, reset 2FA, and re-setup anytime!
    </div>

    <!-- Status Check Section -->
    <div class="step">
        <h2>üîç Check Current 2FA Status</h2>
        <p>First, let's check the current 2FA status for users:</p>
        <div>
            <label><input type="radio" name="statusUser" value="john" checked> john</label>
            <label><input type="radio" name="statusUser" value="admin"> admin</label>
        </div>
        <div class="button-group">
            <button class="status-btn" onclick="checkStatus(false)">Check Basic Status</button>
            <button class="status-btn" onclick="checkStatus(true)">Check Detailed Status (with password)</button>
        </div>
        <div id="statusResponse" class="response" style="display:none;"></div>
        <div id="statusDisplay" class="status-display" style="display:none;"></div>
    </div>

    <!-- Reset Section -->
    <div class="step">
        <h2>üîÑ Reset 2FA (if needed)</h2>
        <p>If 2FA is already enabled and you want to reset it:</p>
        <div>
            <label><input type="radio" name="resetUser" value="john" checked> john (password: password123)</label>
            <label><input type="radio" name="resetUser" value="admin"> admin (password: admin123)</label>
        </div>
        <div class="button-group">
            <button class="reset-btn" onclick="reset2FA()">Reset 2FA</button>
            <button onclick="forceResetAndSetup()">Reset & Start New Setup</button>
        </div>
        <div id="resetResponse" class="response" style="display:none;"></div>
    </div>

    <!-- Setup Section -->
    <div class="step" id="step1">
        <h2>Step 1: Setup/Re-setup 2FA</h2>
        <p>Select a user and start 2FA setup:</p>
        <div>
            <label><input type="radio" name="user" value="john" checked> john (password: password123)</label><br>
            <label><input type="radio" name="user" value="admin"> admin (password: admin123)</label>
        </div>
        <div class="button-group">
            <button onclick="startSetup(false)">Start Normal Setup</button>
            <button onclick="startSetup(true)">Force Reset & Setup</button>
        </div>
        <div id="setupResponse" class="response" style="display:none;"></div>
    </div>

    <div class="step" id="step2">
        <h2>Step 2: Scan QR Code</h2>
        <p>Scan this QR code with your authenticator app:</p>
        <div class="qr-code" id="qrCodeContainer" style="display:none;">
            <img id="qrCodeImage" src="" alt="2FA QR Code">
            <div class="manual-key">
                <strong>Manual Entry Key:</strong><br>
                <span id="manualKey"></span>
            </div>
            <div>
                <strong>Backup QR Code:</strong><br>
                <button onclick="showBackupQR()">Show Backup QR Service</button>
                <img id="backupQrCodeImage" src="" alt="Backup QR Code" style="display:none;">
            </div>
        </div>
        <button id="continueToVerify" onclick="showVerificationStep()" disabled>Continue to Verification</button>
    </div>

    <div class="step" id="step3">
        <h2>Step 3: Verify Setup</h2>
        <p>Enter the 6-digit code from your authenticator app:</p>
        <input type="text" id="verifyCode" placeholder="000000" class="code-input" maxlength="6">
        <button onclick="verifySetup()">Verify & Enable 2FA</button>
        <div id="verifyResponse" class="response" style="display:none;"></div>
    </div>

    <div class="step" id="step4">
        <h2>Step 4: Test 2FA Login</h2>
        <p>Now test the complete login process with 2FA:</p>
        <input type="text" id="loginCode" placeholder="000000" class="code-input" maxlength="6">
        <button onclick="testLogin()">Login with 2FA</button>
        <div id="loginResponse" class="response" style="display:none;"></div>
    </div>

    <div class="step">
        <h2>üîç Understanding TOTP Codes</h2>
        <p>Current timestamp: <span id="currentTime">0</span></p>
        <p>Time window: <span id="timeWindow">0</span> (changes every 30 seconds)</p>
        <p>Codes generated are based on:</p>
        <ul>
            <li><strong>Secret Key:</strong> Unique per user</li>
            <li><strong>Time Window:</strong> Current time √∑ 30 seconds</li>
            <li><strong>HMAC-SHA1:</strong> Cryptographic hash function</li>
        </ul>
        <button onclick="showTimeInfo()">Update Time Info</button>
    </div>

    <script>
        let selectedUser = 'john';
        let setupComplete = false;
        let currentQrUrls = null;

        // Update time information
        function showTimeInfo() {
            const now = Math.floor(Date.now() / 1000);
            const timeWindow = Math.floor(now / 30);
            document.getElementById('currentTime').textContent = now;
            document.getElementById('timeWindow').textContent = timeWindow;
        }

        // Update time info every second
        setInterval(showTimeInfo, 1000);
        showTimeInfo();

        // Get selected user from radio buttons
        function getSelectedUser(radioName = 'user') {
            const radios = document.querySelectorAll(`input[name="${radioName}"]`);
            for (let radio of radios) {
                if (radio.checked) {
                    return radio.value;
                }
            }
            return 'john';
        }

        // Check 2FA status
        async function checkStatus(detailed = false) {
            const user = getSelectedUser('statusUser');
            const password = user === 'john' ? 'password123' : 'admin123';
            const responseDiv = document.getElementById('statusResponse');
            const statusDiv = document.getElementById('statusDisplay');
            
            try {
                let response;
                if (detailed) {
                    response = await fetch('status.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: user, password })
                    });
                } else {
                    response = await fetch(`status.php?username=${user}`);
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    responseDiv.className = 'response info';
                    responseDiv.innerHTML = `‚ÑπÔ∏è Status Check Result:\n\n${JSON.stringify(data, null, 2)}`;
                    
                    // Show user-friendly status
                    let statusHtml = `<h3>Status for ${user}:</h3>`;
                    statusHtml += `<p><strong>2FA Enabled:</strong> ${data.totp_enabled ? '‚úÖ Yes' : '‚ùå No'}</p>`;
                    statusHtml += `<p><strong>Has Secret:</strong> ${data.has_secret ? '‚úÖ Yes' : '‚ùå No'}</p>`;
                    
                    if (data.setup_status) {
                        statusHtml += `<p><strong>Setup Status:</strong></p><ul>`;
                        for (let [key, value] of Object.entries(data.setup_status)) {
                            if (value) {
                                statusHtml += `<li>${key.replace(/_/g, ' ')}: ‚úÖ</li>`;
                            }
                        }
                        statusHtml += `</ul>`;
                    }
                    
                    if (data.available_actions) {
                        statusHtml += `<p><strong>Available Actions:</strong> ${data.available_actions.join(', ')}</p>`;
                    }
                    
                    statusDiv.innerHTML = statusHtml;
                    statusDiv.style.display = 'block';
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.innerHTML = `‚ùå Status Check Failed:\n\n${JSON.stringify(data, null, 2)}`;
                }
                
                responseDiv.style.display = 'block';
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.innerHTML = `‚ùå Error: ${error.message}`;
                responseDiv.style.display = 'block';
            }
        }

        // Reset 2FA
        async function reset2FA() {
            const user = getSelectedUser('resetUser');
            const password = user === 'john' ? 'password123' : 'admin123';
            const responseDiv = document.getElementById('resetResponse');
            
            if (!confirm(`Are you sure you want to reset 2FA for ${user}? This will disable 2FA and require re-setup.`)) {
                return;
            }
            
            try {
                const response = await fetch('reset.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password, confirm_reset: true })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    responseDiv.className = 'response success';
                    responseDiv.innerHTML = `‚úÖ 2FA Reset Successful!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.innerHTML = `‚ùå Reset Failed:\n\n${JSON.stringify(data, null, 2)}`;
                }
                
                responseDiv.style.display = 'block';
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.innerHTML = `‚ùå Error: ${error.message}`;
                responseDiv.style.display = 'block';
            }
        }

        // Force reset and start setup
        async function forceResetAndSetup() {
            const user = getSelectedUser('resetUser');
            
            if (!confirm(`Reset 2FA for ${user} and start new setup immediately?`)) {
                return;
            }
            
            // Set the user radio button for setup
            document.querySelector(`input[name="user"][value="${user}"]`).checked = true;
            
            // Start setup with force reset
            await startSetup(true);
        }

        // Start 2FA setup
        async function startSetup(forceReset = false) {
            selectedUser = getSelectedUser();
            const password = selectedUser === 'john' ? 'password123' : 'admin123';
            const responseDiv = document.getElementById('setupResponse');
            
            const requestBody = { username: selectedUser, password };
            if (forceReset) {
                requestBody.force_reset = true;
            }
            
            try {
                const response = await fetch('setup.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    responseDiv.className = 'response success';
                    responseDiv.innerHTML = `‚úÖ 2FA Setup ${forceReset ? '(After Reset)' : 'Started'}!\n\n${JSON.stringify(data, null, 2)}`;
                    
                    // Show QR code
                    document.getElementById('qrCodeImage').src = data.qr_code_url;
                    document.getElementById('manualKey').textContent = data.manual_entry_key;
                    document.getElementById('qrCodeContainer').style.display = 'block';
                    document.getElementById('continueToVerify').disabled = false;
                    
                    // Store QR URLs for backup
                    currentQrUrls = data.qr_code_urls;
                    
                    // Mark step 1 as completed and activate step 2
                    document.getElementById('step1').classList.add('completed');
                    document.getElementById('step2').classList.add('active');
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.innerHTML = `‚ùå Setup Failed:\n\n${JSON.stringify(data, null, 2)}`;
                }
                
                responseDiv.style.display = 'block';
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.innerHTML = `‚ùå Error: ${error.message}`;
                responseDiv.style.display = 'block';
            }
        }

        // Show backup QR code
        function showBackupQR() {
            if (currentQrUrls && currentQrUrls.quickchart) {
                const backupImg = document.getElementById('backupQrCodeImage');
                backupImg.src = currentQrUrls.quickchart;
                backupImg.style.display = 'block';
            } else {
                alert('No backup QR code available. Please complete setup first.');
            }
        }

        // Show verification step
        function showVerificationStep() {
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.add('active');
        }

        // Verify 2FA setup
        async function verifySetup() {
            const code = document.getElementById('verifyCode').value;
            const responseDiv = document.getElementById('verifyResponse');
            
            if (!code || code.length !== 6) {
                responseDiv.className = 'response error';
                responseDiv.innerHTML = '‚ùå Please enter a 6-digit code';
                responseDiv.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('verify.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: selectedUser, code })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    responseDiv.className = 'response success';
                    responseDiv.innerHTML = `‚úÖ 2FA Enabled Successfully!\n\n${JSON.stringify(data, null, 2)}`;
                    
                    // Mark step 3 as completed and activate step 4
                    document.getElementById('step3').classList.add('completed');
                    document.getElementById('step4').classList.add('active');
                    setupComplete = true;
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.innerHTML = `‚ùå Verification Failed:\n\n${JSON.stringify(data, null, 2)}`;
                }
                
                responseDiv.style.display = 'block';
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.innerHTML = `‚ùå Error: ${error.message}`;
                responseDiv.style.display = 'block';
            }
        }

        // Test 2FA login
        async function testLogin() {
            if (!setupComplete) {
                alert('Please complete the 2FA setup first!');
                return;
            }
            
            const code = document.getElementById('loginCode').value;
            const responseDiv = document.getElementById('loginResponse');
            
            if (!code || code.length !== 6) {
                responseDiv.className = 'response error';
                responseDiv.innerHTML = '‚ùå Please enter a 6-digit code';
                responseDiv.style.display = 'block';
                return;
            }
            
            const password = selectedUser === 'john' ? 'password123' : 'admin123';
            
            try {
                const response = await fetch('login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: selectedUser, 
                        password, 
                        totp_code: code 
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    responseDiv.className = 'response success';
                    responseDiv.innerHTML = `üéâ 2FA Login Successful!\n\n${JSON.stringify(data, null, 2)}`;
                    document.getElementById('step4').classList.add('completed');
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.innerHTML = `‚ùå Login Failed:\n\n${JSON.stringify(data, null, 2)}`;
                }
                
                responseDiv.style.display = 'block';
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.innerHTML = `‚ùå Error: ${error.message}`;
                responseDiv.style.display = 'block';
            }
        }

        // Allow only numeric input in code fields
        document.getElementById('verifyCode').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
        });
        
        document.getElementById('loginCode').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
        });
    </script>
</body>
</html>
