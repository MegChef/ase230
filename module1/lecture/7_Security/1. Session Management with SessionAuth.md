---
marp: true
theme: default
class: lead
paginate: true
backgroundColor: #fff
---

<!-- _class: frontpage -->
<!-- _paginate: skip -->

# Session Management with SessionAuth

From Simple Concepts to Working Code

---

<style scoped>
li { font-size: 12pt !important; line-height: 1.2 !important;}
</style>

- [Sessions](#sessions)
  - [The Problem: HTTP is Stateless](#the-problem-http-is-stateless)
  - [What Are Sessions?](#what-are-sessions)
  - [How Sessions Work: Step by Step](#how-sessions-work-step-by-step)
- [Session PHP Example (session/basic)](#session-php-example-sessionbasic)
  - [index.php](#indexphp)
  - [login.php](#loginphp)
  - [check.php (See What's Stored)](#checkphp-see-whats-stored)
  - [welcome.php](#welcomephp)
  - [logout.php (Destroy Session)](#logoutphp-destroy-session)
- [Rewrite using the SessionAuth class (session/sessionauth)](#rewrite-using-the-sessionauth-class-sessionsessionauth)
  - [Problems with Basic Approach](#problems-with-basic-approach)
  - [Solution: SessionAuth Class](#solution-sessionauth-class)
  - [SessionAuth Benefits](#sessionauth-benefits)
  - [Code Comparison: Login](#code-comparison-login)
  - [Code Comparison: Authentication](#code-comparison-authentication)
  - [Hands-On Exercise](#hands-on-exercise)
- [Other Session Related Topics](#other-session-related-topics)
  - [Session vs Cookies](#session-vs-cookies)
  - [What you could add to SessionAuth (Optional)](#what-you-could-add-to-sessionauth-optional)
  - [Common Session Problems \& Solutions](#common-session-problems--solutions)
  - [Session Best Practices](#session-best-practices)
  - [Real-World Applications](#real-world-applications)
- [Key Takeaways](#key-takeaways)
  - [Sessions Enable](#sessions-enable)
  - [Security Features](#security-features)

---

## Sessions

- ü§î What are sessions and why do we need them?
- üîß How PHP sessions work step-by-step
- üíª Building a simple session system
- üõ°Ô∏è Session security best practices
- üéØ Hands-on coding examples

---

### The Problem: HTTP is Stateless

```text
User visits page 1: "Hi, I'm John"
User visits page 2: "Who are you again?" ü§∑‚Äç‚ôÇÔ∏è
```

#### Each request is independent

- Server forgets everything after each request
- No memory of previous interactions
- How do we remember users across pages?

**Solution: Sessions!**

---

### What Are Sessions?

**Sessions = Server's memory of your visit**

```php
// When you login:
$_SESSION['username'] = 'john';
$_SESSION['logged_in'] = true;

// Later, on any page:
echo "Welcome back, " . $_SESSION['username'];
// Outputs: Welcome back, john
```

#### Key Concept

- Server stores your data
- Browser gets a "ticket number" (session ID)
- Browser shows ticket, server finds your data

---

### How Sessions Work: Step by Step

*Step 1: Start Session*

```php
session_start(); // Must be first line!
```

*Step 2: Store Data*

```php
$_SESSION['user_id'] = 123;
$_SESSION['username'] = 'john';
```

---

*Step 3: PHP Magic*

- PHP creates unique session ID: for example, `abc123def456`
- PHP sends cookie to browser: `PHPSESSID=abc123def456`
- PHP saves your data on the server

*Step 4: Remember Later*

- Browser sends cookie to PHP with every request
- Using the cookie, PHP loads your data automatically
- `$_SESSION` array is ready to use!

---

## Session PHP Example (session/basic)

In the session/basic directory, run `php -S localhost:8000` to start PHP server.

Open a browser, and access the PHP server at <http://localhost:8000>.

---

### index.php

When users access the PHP server, `index.php` is accessed automatically.

1. It starts the session.

```php
<?php
session_start();
?>
```

2. It displays information.

```html
<h1>Session Demo - Super Simple</h1>
...
<h2>Try it:</h2>
<p><a href="login.php">1. Login (john/secret)</a></p>
...
<p><a href="logout.php">5. Logout</a></p>
```

---

3. It reads the $_SESSION to check the user is logged in or not.

```php
<?php if (isset($_SESSION['logged_in']) && $_SESSION['logged_in']): ?>
    <h3>Current Status: Logged in as <?= $_SESSION['username'] ?> (ID: <?= $_SESSION['user_id'] ?>)</h3>
<?php else: ?>
    <h3>Current Status: Not logged in</h3>
<?php endif; ?>
```

- isset($_SESSION['logged_in']) ‚Üí a flag that there is a variable $_SESSION['logged_in].
- $_SESSION['logged_in'] ‚Üí a flag that should have been set at login (true if user is authenticated).
- It displays the $_SESSION['username'] and $_SESSION['user_id'] when the user is logged in.

---

### login.php

```php
<?php
session_start();

if ($_POST['username'] == 'john' && $_POST['password'] == 'secret') {
    $_SESSION['user_id'] = 1;
    $_SESSION['username'] = 'john';
    $_SESSION['logged_in'] = true;
    header('Location: welcome.php');
    exit;
}
?>
```

---

- In the login.php, this is the form that users can use to give user name and password.

```html
<form method="post">
 Username: <input type="text" name="username"><br>
 Password: <input type="password" name="password"><br>
    <input type="submit" value="Login">
</form>
```

---

- When users give correct username/password, session variables are set, including $_SESSION['logged_in'].

```php
<?php
session_start();

if ($_POST['username'] == 'john' && $_POST['password'] == 'secret') {
    $_SESSION['user_id'] = 1;
    $_SESSION['username'] = 'john';
    $_SESSION['logged_in'] = true;
    header('Location: welcome.php');
    exit;
}
?>
```

---

### check.php (See What's Stored)

- Users can access this page only when they are loggined in the session is created.
- The session data is accessible with the `session_id()` function.

```php
<p><strong>Session ID:</strong> <?= session_id() ?></p>

<p><strong>What's in $_SESSION:</strong></p>
<pre><?php print_r($_SESSION); ?></pre>

<?php if ($_SESSION['logged_in']): ?>
 <p>Status: ‚úÖ Logged in as <?= $_SESSION['username'] ?></p>
<?php else: ?>
 <p>Status: ‚ùå Not logged in</p>
<?php endif; ?>
```

---

### welcome.php

**Magic**: This page "knows" who you are!

```php
<?php
session_start();

// Check if user is logged in
if (!$_SESSION['logged_in']) {
    header('Location: login.php');  // Redirect to login
    exit;
}
?>

<h1>Welcome!</h1>
<p>Hello, <?= $_SESSION['username'] ?>!</p>
<p>You are logged in.</p>

<a href="logout.php">Logout</a>
```

---

### logout.php (Destroy Session)

```php
<?php
session_start();
session_destroy();  // Forget everything
?>

<h1>Logged Out</h1>
<p>Your session has been destroyed.</p>
<a href="login.php">Login Again</a>
```

---

- `session_destroy()` deletes all session data
- Server forgets who you are
- Protected pages will redirect to login

---

## Rewrite using the SessionAuth class (session/sessionauth)

---

### Problems with Basic Approach

*Code Duplication*

```php
// Must copy this to every protected page
session_start();
if (!$_SESSION['logged_in']) {
    header('Location: login.php');
    exit;
}
```

---

*Security Issues*

- No session regeneration (session fixation attacks)
- Incomplete logout (session data may remain)
- Inconsistent authentication checks

---

### Solution: SessionAuth Class

**Object-Oriented Approach = Better Code + Better Security**

```php
class SessionAuth {
    public function __construct() {
        if (session_status() === PHP_SESSION_NONE) {
            session_start();
        }
    }
    
    public function login_user($user) {
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];
        $_SESSION['logged_in'] = true;
        
        // Security: Prevent session fixation
        session_regenerate_id(true);
    }
```

---

```php
    public function logout_user() {
        session_unset();   // Clear data
        session_destroy(); // Destroy session
    }
    
    public function is_logged_in() {
        return isset($_SESSION['logged_in']) && $_SESSION['logged_in'] === true;
    }
```

---

- These functions require the user to be logged in.

```php
    public function get_user() {
        if ($this->is_logged_in()) {
            return [
                'id' => $_SESSION['user_id'],
                'username' => $_SESSION['username']
            ];
        }
        return null;
    }
    
    public function require_auth($login_url = 'login.php') {
        if (!$this->is_logged_in()) {
            header("Location: $login_url");
            exit;
        }
    }
}
```

---

### SessionAuth Benefits

#### üéØ **Clean Code**

```php
// Old way (repeated everywhere)
session_start();
if (!$_SESSION['logged_in']) {
    header('Location: login.php');
    exit;
}

// New way (one line)
$auth = new SessionAuth();
$auth->require_auth();
```

---

#### üõ°Ô∏è **Built-in Security**

- Automatic session regeneration on login
- Complete session cleanup on logout
- Consistent authentication across all pages

---

### Code Comparison: Login

#### Basic Approach (Security Risk!)

```php
if ($username === 'john' && $password === 'secret') {
    $_SESSION['user_id'] = 1;
    $_SESSION['username'] = 'john';
    $_SESSION['logged_in'] = true;
    // No session regeneration! üö®
}
```

---

##### Session Fixation Attack

**Problem**: Attacker sets victim's session ID, waits for login

```php
// Basic approach - VULNERABLE
$_SESSION['logged_in'] = true;
// Session ID stays the same! üö®
```

**Solution**: SessionAuth regenerates the session ID

---

#### SessionAuth Approach (Secure!)

```php
if ($username === 'john' && $password === 'secret') {
    $user_data = ['id' => 1, 'username' => 'john'];
    $auth->login_user($user_data); // Includes security features ‚úÖ
}
```

**SessionAuth automatically prevents session fixation attacks!**

---

### Code Comparison: Authentication

#### Basic Approach (Must Repeat)

```php
// Copy this to EVERY protected page
session_start();
if (!$_SESSION['logged_in']) {
    header('Location: login.php');
    exit;
}
// Easy to forget! üò∞
```

---

#### SessionAuth Approach (DRY Principle)

```php
// One line protects any page
$auth = new SessionAuth();
$auth->require_auth(); // Clean and consistent! üòä
```

**DRY = Don't Repeat Yourself**

---

### Hands-On Exercise

#### Try Both Approaches

**Basic Version**: `/session/basic/`

- Simple but has security issues
- Code duplication everywhere
- Manual session management

**SessionAuth Version**: `/session/sessionauth/`

- Secure and professional
- Clean, reusable code
- Automatic security features

---

## Other Session Related Topics

### Session vs Cookies

| Method       | Server Storage | Client Storage  | Security  | Expiration      |
|--------------|----------------|-----------------|-----------|-----------------|
| **Sessions** | ‚úÖ Yes          | Session ID only | ‚úÖ High    | Server controls |
| **Cookies**  | ‚ùå No           | ‚úÖ Full data     | ‚ö†Ô∏è Medium | Client controls |

**Sessions are most secure for sensitive data!**

---

### What you could add to SessionAuth (Optional)

```php
// Password hashing
public function verify_password($input, $hash) {
    return password_verify($input, $hash);
}

// Session timeout
public function check_timeout($minutes = 30) {
    // Implementation here
}
```

---

```php
// Remember me functionality
public function set_remember_token($user_id) {
    // Implementation here
}

// Role-based access
public function require_role($role) {
    // Implementation here
}
```

### Common Session Problems & Solutions

#### Problem 1: Session Not Starting

```php
// ‚ùå Wrong - session already started elsewhere
session_start();

// ‚úÖ Correct - check first
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}
```

---

#### Problem 2: Headers Already Sent

```php
// ‚ùå Wrong - output before session_start()
echo "Hello";
session_start(); // Error!

// ‚úÖ Correct - session_start() first
session_start();
echo "Hello";
```

#### Problem 3: Session Data Lost

```php
// ‚ùå Wrong - forgot to start session
$_SESSION['user'] = 'john'; // Won't work!

// ‚úÖ Correct - start session first
session_start();
$_SESSION['user'] = 'john';
```

---

### Session Best Practices

#### 1. Always Check Session Status

```php
public function __construct() {
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }
}
```

#### 2. Secure Session Configuration

```php
// In your main configuration file
ini_set('session.cookie_httponly', 1); // Prevent JavaScript access
ini_set('session.cookie_secure', 1);   // HTTPS only
ini_set('session.use_strict_mode', 1); // Strict session ID generation
```

---

#### 3. Clean Session Data

```php
public function logout_user() {
    session_unset();   // Clear all $_SESSION data
    session_destroy(); // Destroy the session file
    
    // Optional: Clear the session cookie
    if (isset($_COOKIE[session_name()])) {
        setcookie(session_name(), '', time() - 3600, '/');
    }
}
```

---

### Real-World Applications

#### E-commerce Sites

- Shopping cart contents
- User preferences
- Login status

#### Social Media

- User identity
- Privacy settings
- Recent activity

---

#### Banking Applications

- Secure authentication
- Transaction state
- Security timeouts

#### Your Projects

- User management systems
- Admin panels
- Any application requiring login

---

## Key Takeaways

### Sessions Enable

1. **User Authentication** - Remember who's logged in
2. **State Management** - Maintain data across requests
3. **Security** - Server-side data storage
4. **User Experience** - No need to login repeatedly

---

### Security Features

- **Session ID regeneration** prevents fixation attacks
- **Timeout handling** limits exposure window
- **Activity tracking** enables idle detection
- **Proper cleanup** prevents data leaks
